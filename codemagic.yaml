workflows:
  android-workflow:
    name: Android workflow
    environment:
      vars:
        KEYSTORE: Encrypted(Z0FBQUFBQmhKQlh5YnNaUV9jTTM0MHdRQkZpUFRkVnBpdWJLbkNnZTdmdEpZYzJvcmpTUTBlNjQ3VkZrRkJSZDVhRjBZdjlKaUN4bU5FX1k4Y05lUk1rYzJkdHBHTFNUbkQxeU1ibGpVVVhtc09odjZ0RHdiWWhDdy1VUm05Ym5ia2x1azVPT2MweDFYWEpyNWFyc0piQWRxRmwzZlFWNVVtQlJHZkRldlp2MHRGLWNOejh6RkdMeDVja04wTUxXZnEyQkg0dTgxMjZNU0lRZEUzSDhhS0RCeXAwVWJYdlBYUlA3WHdHUzVxdmFoRkpjYm95WHhscFhBeHdWRHZWbXk3ODZOd3l3Ym1KLWtScHVyM21XTVVmbllaSTU3Vmk2b1BOWnV3cFNJTk5SZWJwbFk0V1NEYWNWZ19wbmwzX2tPVTF4dTY2MnVKNkZqOTJ6SnhqMVEtLXVOWWM4WjVCR3U4LUtTYjd0Vlo5c0VwSTREQUxlb05sLUZPcExoZldjOHBYMVhJYXlKZ0JLVmZrZktpbmt3MGVqUVltUGtoQ1pRRWJFZmtrQy1TazUyNTVsSjF5bDVaN0ZVNUtmb25Gc2RYRERwS0N1ZS0xZ25mbGlQUzNkZnhRTXYza3V5Vl9uU0h2Yl9WeENrLVdVOW1paXVTcUFNN1ZScEU5TjZqeG9CbXJnZWtQM0xVamxkSlJTdDVNUFhnNWpkTHhpWHpudUZ2Q1NkUm42QlNxb2l0WDQ2T0hzY001eGYwUVZaTkpiaDlEcjBIUGNYek5iVXM5cHEwdlJmdHFISXZ5TDdkazhiclB1d1hzNHFYUWV4WjhaczV1eTJyLVBESnE5OEFvWEdRR0RucmJCc25XUlhBUjBvNVBId1JfdVVSdklhdzNyZDN4LW1vbnpsRkU2Yjc4UlZ4QjVnQnJPVWd2aDhBTWxmMUU1VHE2UEVSUFRrUnowNTFvaUcyOFh1WkZFRkh3aVF1QUdhZ2ZGeGtMQzFhU3kwNFBKQUJEVXlnRXZWSEZmWWRoVklOOVh1SWJ4SXZNb1R4Q0w2VVZ5ZW52UXpnZUFVcmpZN1RkVGhPbjRaZlE4bDA4d3pGUWplZ20waExWM0lZcnNoVWpTYU9NckotUGFUcVJ1WGdqUnNVNjdvYlhZYXZWUldHemd4RGJMQklOT18zRTNlY2dLT2xrTzFBOElFeTc5QmxCVHpXMkI2WkJQRE5Cdm5CWHFfQzN4ejZhZU1Vdm1keF9ydHpHSXhSSnB3WTZIMFFCZUIzUWhjeS1mLUsxQUdQRjN2eENkam9oTDJhMWZVYVVBeFozWVlneEh3ejFxQmhpVDd6ODctM25hLTNyb2pOV0gyRnZZSVNrVXJvR2p6RWpkV0MyYkpvN2ZvbG43dThmeGlacm9rNWhpT2dlWVhnRTk4a0pUVXpneEQ2WkZnSVVfTHZTZUdvbW1uTkFWb3FtdjlMOWJDR3YwM0hpNERfdWliQXlRSWhIT080a2dkTE5jcy0xallKSHhFSllpT2trWXFnb3hHdXAycEJIbU5Udjk2dUdFcjNGajJGUUZaR2g4QWVnYnV5Nmd3cF95LUFQMDBWRVJ0cFlsY0JZUklTYS00YTNWejVyUTIzYndLN0Q5dDlnS0dyX3lrRkFGbzJRbXpPdmFtU1pSbzlfeE9tMXROODJzekUwZGxQMFV6QXEzYmdudG1XRUJTc1BFVTlzNmJZOVZDVVJrdVdYa1hLdl9Ra1duS3N1LVRnNjVPcV9kZFIySkdSSk1YbDlsb0xnbFdRU1Fmd1JJQnMzdDBOcDZ3TkFTalNSdS1LemhqV2NtNDhKWTJYUUU2QXBycHhabU9ONzczNUJqR0lnMTNabFdhRUpMbE1SQ0lDcWVnWnZkNWlWUWJSTjQxMU9SRzZGVjFTbVpCZFBOeGVzam5hanY5OThzRXQzZjhjcnM5QzdtUlJUMUNyUjZCWHFrNGJNMm1HbFVFRy05RWZWUzh0dUJaaU1oc010dFZRelpNa3NMaElQR2V2SnRjaENlN2g4eXVjci0zRmRqVUcwR3JfSFV3VXpaNmZ6cHR5U29NMmFEamZuRkpWb0dwdGk2QnVSaE92YVpiTGxoaUJRa1J0T2RXZktPTU81X2R5bWo5OVE3M1pDSzNOVW9PSmEtTGQ3aTUyd3J2clUzaTBTZWpLSmJkdVNRTjFSbnNYZUhFY3VCWnlDWnBfZWNMOTVhMTJjZTFNSE93Q2ZYMjh6QmFhd1FSYzJ5aUdfMUwzdXE5LTRORXlZVWpJZWt6M242bVhMMkc4NGx6TU56dFRUU2FUdGJhamJFVElQVHgtay1QQXE2YlcwQWpmNGhwUFpYQmhUajhkaVJFY2poLXJOelZYbDBwZXhsdzZfWTY1cTJfZ0FIWDA2UTNiWkp4ZF83a012anV5YWg2N1RVSWVnNDZhOUVqNTl0WkhPTl9NbFJnU2hvMzNBMHJKSGhxbmw1elVFN1V4QkpjOUUyU1NyLXlXSUZGZGZOSmxmbzFkMUNDQzh6V0haTkxVLTVhSHFmSDBVZUVhTnY0aWFraVZCdE8xNkZCNjdab2lBMnhKSEc4SEVmWHptU01LaG04eXIyckhrbV9NUk5vRW51cC1nZkltS2p6SDBLYU9EUUUwOG16eUJWQ1BZdTFRUndRSE81SVU0d2RYTmFKSWhMSDF0RWJVNkJXcE5IbVJpS3RXRjg5eXFBbkE3aUVrWTNYN1pndEl2b0VQTzJvY3ZEdTlDQ0dCV1FjTGw3VWgzb0NCTk9tYjdtNjBtaDJQR3lfNXFEODFWUUtiV3BZREpMNVhBWWxwdE41d25RbGQ3OXlCSG5xRmxvYWdVaER0cnU2WXY1SnAzLTB1aEVFNU9fd0gwZFJpYVRSR25qTUFuVnZGZE8yVU1ic2d4VVJlNnlWXzV0VTZiWWlXTjBxVmRLZG4xRDlIYlV6c2REcVFJbTU5N0hhZ2YxbXN6SGR3SVZQa09aLThoM18zUXpkcjlJRFJfY0xmdGZiWjJnT2UxbnZuRGxxVGpzMFVzYVd1NllvY0NRNS1mQWJQVGVwV25nd01RMjZpV0xQMW9wRmppczVJZG5sSVpBVjZfaEpQQWNPSS00T3F3cl9WQUhGNzQyMlBYM3kxMHpUOWNmMWJ6OGE4NXJ0WmlRYmtxNnc2anpfNXFzc0JCbU5mRUVVRW9rUzY2Tjk4R2NPWUkzOHY5VjFrMVJxNk45WFU3ZnVDcm1tbXlxTzZkUEVSX2RGaGlhSnZwN3RwYWlUSWRpdUFMT2dMcTJvY0dNcHd6TWhpVE80RFdZS1hhdmFnUTQ0MnpodU5hT2loUlMzTVl5anZIVnMzWVpiazQ5VXhEMEhYd25NUGxUampkZkFQYUJLTTJGYVd6d1N6UDlCU0dMOXFkckhEOGdYTllkbXlqODVMQ0lQLUVpNmJoT2xRcm1mWXdNYlFjV2tacjB0N0RNclBSSGNRbF85LWFTSGVHRzNyLW1aQ2Vsb1RKNzZ6dXNBRUlsN1NURk5RWGJtSkxhYU5DbFRJQTA1aWJ6blZ0YlNXZ1ZXb1B6c3ZYSF8zOXUtQTJyOUFxVzFBWXlhZDQyQWdhR3hERlJhaDRGTlV2cnprbE1JUEZMT1lmc1llc19FcXE4cEZJX2xmSEtSekwwTERfN2NNVFo3dEIyVXJaaUpDOUhRMGNZOWZ4WWxUcDBETUgwMkZyMFBDRTFmQkdDdW9BaXhVSEwyUlRWamhMOC1GbkQ1TWVHTlNnNVd0REQ1aFNWQkVYVFh5VW01eVZ6YTJ6MWNXWHRSV0NpWTVtdXpyWmtqVGdIUnlkT05zc2ROaEZFUVFDU05TLU1tOFZTU0ZyZVdBc2lRQWFoRDFPLVdVUk5xRVh0VkdNc1d3cU1SZVdqckdLajhadXd5azhoVnRvMUlfUDRRUTl6ZXhYdHUwU3o0VnpSelRUaWt3RGRfQ2sxcXpTQXlWa0RRZGRrclV5c0xnRnNXSHd3Q2YtWWxsZzVfZGNESktpeUg1Q2d4RklEYUJqeldRNnA0NVZtWDZ1Ym5nNDIyQ2NBUUdsYkZxRWhQaGQ0VW1SdVdJeGFKX0tZY2xjWGgtUmY4MTltVW9pbGRLRFZMOWVKbXNnNlhuU0RBSmdnb2JBZ3hocVlkejZ5RExLdzVWcF9ZVi10Z25jMzd2VmtCNl9JTmc1ZWswSUJKNXZnY3pNU3I5V2NKa0JYYWtSMlN6aUk2aDdiQkpobTRNb2RTM1hxeXVLSXBsWkpsN1IwdG1mSVFJXzdUQUZhekMwMVJsY0I3X2RoLWFtRXozU21qYllENkZfQTFmNnI1SmZ6VkJQSlBVSHF1WlpKSDFjSm5DR1lYWHpRUDZZazUyOGUtQ25uckxMMlRuWGZOTjRSUUs4S1p2Yzg4ZnYzQko1eWtld1o3X1BRNjR4a01JcGkxUFg5MUVaR1I5MWtCdUFSdXdZWWI3Tk5SQjYtTlNhS2xqYjNYNG9UNnh0TjM0MWpuenlQczl4QmpKR3dmZ3FueFBzYVVabU9kb1liQzlIMEVNMkEzVUwzRkdfVHdMQnY3N3dCbWxad2loV2l1TW5WWGs3a3pZRnU2c2JNUjRwbi12SjlsdmV5d2VkRXctRlBodjBHVHJaR1hzVU5XdlhoVmNjeTFfWGNGNWZpcTlIRF81ajVibV8zeThyczhQYm1VRTVpUHIxWjFWcTZtaTlEQy1xTHRMM0hqd2RWRGN1alJISlZfNVpybTZOSVBRWEtFYlNUNHMwRkZWRzhXSG1GQkVoc3dOV2c2WlJfZmFwcjk5R21TQnUzTFNIU2k3RGxNSDBWWkM0ekNLTzQ4QjlMRTBPcWFjTW9GSTNCXzNveFBWWGZtdFJRaTZOT042U080RlZNNTRSWEtocU5CdUh2Szk2T054dGpfX2hEcWRCajJkcUFRZ0dmUE8tUUdxVFNUM3FsZHIzMDdkVzhnaFZHTGpaWWZVWm52V3RHc0tiX3hhLTQ5TVo2eWxSdGkzWUtyS1prNTFOUmloTWNGVms0ZnI0amk1ZFQzUHVmb1h6cDBneXFFWGJncTVzcHNoSXcxV1dJa0QxdnlzQUVqOGtmZTFab1Q5Y193ODRHR1p3TkYya3NWOEpOYnVTWGhudnNhbHM1Qm5ZU2gzYUh3N2htR3laVmg1Qk12bTVYOG1GSE9haEdWT1lqVWFBcnRzZ3dTbE42eGJjbHFpejZmbGl2NDk0UFF1MGp4dVJzNkQxT25LaE1ZbTl6SWx0ZFhEZXZYeUg5Si1XeUZxM1VhdDZLNDZmam9JRWlSLVUzSEZkZ2dveFc4Q2J2dzdsNnpPVnJQWGdJUHI1NHFERUdsbUFrVGdDb3BWdUNmVlRBS2ZvLWZaTFVYUWpPUzFkQXRqSFFVZmtqS0QyeWZrVnctZDlhaDFDRWxTVEpJS2hPMEp6Tm5UYjJaMkpxS25feWI2UkgwYWIxeWNqYVIxNktVLW10dDNONXRGMWRrWUtmTmM5R3VlSVc2Sl84Xzk4ajBhVU1ZNGM9) # <-- Put your encrypted keystore file here
        KEYSTORE_PATH: '/torchlightpro_keystore.keystore'
        KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmhKQkhuR3FKa3pEM1NxRTRlZVdoVm1TVmoxaG1MZzFjSW0zYkhmcVVTUVJxcnVYWDctaUg4ajlhdjluRG1RV3pENDFfTGwzTmR4RXJiNUpob19VaHpYbGtoTVZEZlMxN3pCR3I4Mjl4OTRzNmxjSXc9) # <-- Put your encrypted keystore password here
        KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmhKQkhuR3FKa3pEM1NxRTRlZVdoVm1TVmoxaG1MZzFjSW0zYkhmcVVTUVJxcnVYWDctaUg4ajlhdjluRG1RV3pENDFfTGwzTmR4RXJiNUpob19VaHpYbGtoTVZEZlMxN3pCR3I4Mjl4OTRzNmxjSXc9) # <-- Put your encrypted keystore alias password here
        KEY_ALIAS: Encrypted(Z0FBQUFBQmhKQkd4N3dDVHV5dFNWOHc2d2NkRGg0aTNaYnFkajNYS2J0c1hkVnFnSXpITFFQTTJha0JNVXR4czNVdFM5VmtLdUt5RWtOaktONzI1QUVnYjdRY2cyR1dDSnc9PQ==) # <-- Put your encrypted keystore alias here
      xcode: 12.4
      node: 12
      npm: 6        
    cache:
      cache_paths:
        - $FCI_BUILD_DIR/node_modules
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm ci
          cvm install 9.0.0
          cvm use 9.0.0        
      - name: Add Android platform
        script: |
          set -x
          cordova platform remove android --nosave
          cordova platform add android --confirm --no-interactive --noresources
      - name: Build Android
        script: |    
          set -x
          set -e
          cordova build android --release --no-interactive --prod --device
          echo $KEYSTORE | base64 --decode > $KEYSTORE_PATH
          UNSIGNED_APK_PATH=$(find platforms/android/app/build/outputs -name "*.apk" | head -1)
          jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore "${KEYSTORE_PATH}" -storepass "${KEYSTORE_PASSWORD}" -keypass "${KEY_ALIAS_PASSWORD}" "${UNSIGNED_APK_PATH}" "${KEY_ALIAS}"
          mv $UNSIGNED_APK_PATH $(echo $UNSIGNED_APK_PATH | sed 's/-unsigned//')
    artifacts:
      - platforms/android/app/build/outputs/**/*.apk
      - platforms/android/app/build/outputs/**/mapping.txt
    publishing:
        # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
        email:
            recipients:
                - user_1@example.com
                - user_2@example.com
            notify:
              success: true     # To not receive a notification when a build succeeds
              failure: false    # To not receive a notification when a build fails
